<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affinidi Iota Framework</title>
    <style>
        /* Intuitive Design Styles - Consistent across all pages */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #eef2f7;
            color: #4a5568;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 900px;
            /* Wider container to accommodate two columns if needed */
            box-sizing: border-box;
            margin-top: 40px;
            margin-bottom: 40px;
        }

        .header-body {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.2rem;
            color: #374151;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .navigation-link {
            display: inline-block;
            margin-bottom: 25px;
            color: #0694a2;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .navigation-link:hover {
            color: #047a85;
            text-decoration: underline;
        }

        .card-body {
            margin-bottom: 30px;
            text-align: center;
        }

        hr.mt-2 {
            border: 0;
            border-top: 2px solid #e0e0e0;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .alert {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            border-width: 1px;
        }

        .alert-danger {
            background-color: #fdecea;
            color: #991b1b;
            border-color: #fcc2c3;
        }

        .alert-success {
            background-color: #e6f9ec;
            color: #155724;
            border-color: #bef2c4;
        }

        .affinidi-login-div {
            margin-bottom: 20px;
        }



        .iota-button,
        #iota-btn {
            /* Button style for Iota Request - similar to CIS page buttons */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 30px;
            background-color: #0694a2;
            /* Teal color for button */
            color: #ffffff;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            margin-top: 20px;
            /* Add some top margin */
            display: inline-block;
            /* To allow width: auto to work if needed */
        }

        .iota-button:hover,
        #iota-btn:hover {
            background-color: #047a85;
            /* Darker teal on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .iota-button:active,
        #iota-btn:active {
            background-color: #03606b;
            /* Even darker teal on active */
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }


        #divMessage {
            margin-top: 25px;
            padding: 0px;
            border-radius: 10px;
            background-color: transparent;
            border: none;
            text-align: center;
            font-size: 1.1rem;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        #divMessage.text-danger {
            color: #991b1b;
        }

        #divMessage b {
            font-weight: 700;
        }

        #divMessage pre {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            text-align: left;
        }

        /* Enhanced Home Button Style */
        .home-button-enhanced {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 30px;
            background-color: #6b7280;
            color: #ffffff;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            margin-bottom: 25px;
            display: inline-block;
        }

        .home-button-enhanced:hover {
            background-color: #4a5568;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .home-button-enhanced:active {
            background-color: #374151;
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        /* Enhanced VP Response Display Styles */
        .vp-response-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            padding: 30px;
            text-align: left;
            margin-bottom: 25px;
            /* Add margin between cards */
        }

        .vp-response-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }

        .vp-response-icon {
            height: 40px;
            width: 40px;
            fill: #10b981;
            margin-right: 20px;
        }

        .vp-response-title {
            font-size: 1.7rem;
            color: #374151;
            margin: 0;
            font-weight: 700;
        }

        .vp-response-body {
            margin-bottom: 20px;
        }

        .vp-response-detail {
            color: #4a5568;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .subject-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .subject-info-item {
            display: flex;
            flex-direction: column;
        }

        .subject-info-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        .subject-info-value {
            background-color: #f0f4f8;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 1rem;
            color: #2d3748;
            overflow-wrap: break-word;
        }

        /* Styles for Complete Response Card */
        .vp-complete-response-card {
            background-color: #f7f7fc;
            /* Lighter background for complete response */
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            /* Slightly less shadow */
            padding: 25px;
            margin-bottom: 30px;
            overflow-x: auto;
            /* Horizontal scroll if needed */
            font-size: 0.9rem;
            /* Slightly smaller font for code */
            font-family: monospace;
            /* Monospace font for code */
            color: #555;
            /* Slightly lighter text color */
            white-space: pre-wrap;
            /* Preserve formatting */
        }

        .vp-complete-response-header {
            font-size: 1.3rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 20px;
            text-align: center;
            /* Center align header */
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <div class="header-body">
            <h1>Affinidi Iota Framework</h1>
        </div>
        <div class="card-body">
            <a href="/" class="home-button-enhanced">Home</a>
        </div>
        <div class="card-body">
            <div class="card-grid" id="divRequest">
                <div class="credential-card">
                    <div class="card-icon">
                        <!-- Personal Info Icon -->
                        <svg width="32" height="32" fill="none" viewBox="0 0 32 32"><circle cx="16" cy="12" r="6" fill="#0694a2"/><rect x="6" y="22" width="20" height="8" rx="4" fill="#4a5568"/></svg>
                    </div>
                    <div class="card-title">Share Personal Information Credentials</div>
                    <button class="iota-button" id="personal-btn">Showcase</button>
                </div>
                <div class="credential-card">
                    <div class="card-icon">
                        <!-- Education Icon -->
                        <svg width="32" height="32" fill="none" viewBox="0 0 32 32"><path d="M16 6l12 6-12 6-12-6 12-6zm0 14v6m-8-8v4c0 2.21 3.58 4 8 4s8-1.79 8-4v-4" stroke="#0694a2" stroke-width="2" fill="none"/></svg>
                    </div>
                    <div class="card-title">Share Education Information Credentials</div>
                    <button class="iota-button" id="education-btn">Showcase</button>
                </div>
                <div class="credential-card">
                    <div class="card-icon">
                        <!-- Employment Icon -->
                        <svg width="32" height="32" fill="none" viewBox="0 0 32 32"><rect x="6" y="12" width="20" height="14" rx="3" fill="#0694a2"/><rect x="12" y="8" width="8" height="4" rx="2" fill="#4a5568"/></svg>
                    </div>
                    <div class="card-title">Share Employment Information Credentials</div>
                    <button class="iota-button" id="employment-btn">Showcase</button>
                </div>
                <div class="credential-card">
                    <div class="card-icon">
                        <!-- Address Icon -->
                        <svg width="32" height="32" fill="none" viewBox="0 0 32 32"><path d="M16 4a8 8 0 0 1 8 8c0 6-8 16-8 16S8 18 8 12a8 8 0 0 1 8-8zm0 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" fill="#0694a2"/></svg>
                    </div>
                    <div class="card-title">Share Address Information Credentials</div>
                    <button class="iota-button" id="address-btn">Showcase</button>
                </div>
                <div class="credential-card">
                    <div class="card-icon">
                        <!-- Selective Sharing Icon -->
                        <svg width="32" height="32" fill="none" viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="#0694a2"/><path d="M16 16V4a12 12 0 0 1 12 12h-12z" fill="#4a5568"/></svg>
                    </div>
                    <div class="card-title">Showcase Selective Sharing Credentials</div>
                    <button class="iota-button" id="selective-btn">Showcase</button>
                </div>
            </div>
            <div id="divMessage"></div>
        </div>
        <style>
            .card-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 28px;
                margin-bottom: 30px;
            }
            .credential-card {
                background: #fff;
                border-radius: 14px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.07);
                padding: 28px 22px 22px 22px;
                display: flex;
                flex-direction: column;
                align-items: center;
                transition: box-shadow 0.2s;
            }
            .credential-card:hover {
                box-shadow: 0 6px 18px rgba(0,0,0,0.13);
            }
            .card-icon {
                margin-bottom: 12px;
                font-size: 2.2rem;
            }
            .card-title {
                font-size: 1.25rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 16px;
                text-align: center;
            }
        </style>
    </div>

    <script>
        const divMessage = document.getElementById('divMessage');
        const responseCode = "{{ response_code }}";
        if (responseCode) {
            divMessage.textContent = "Get the response code from callback url";

            const iotaRedirectString = localStorage.getItem("iotaRedirect") || "{}";
            const iotaRedirect = JSON.parse(iotaRedirectString);
            const params = {
                ...iotaRedirect,
                responseCode
            };
            divMessage.textContent = "Fetching VP Response from the response code";
            fetch('/api/iota-complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(params)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                    if (!data.vpToken) {
                        divMessage.textContent = 'Failed to get response from iota: ' + '' + data.message;
                        divMessage.classList.add('text-danger');
                        window.history.replaceState(null, '', window.location.pathname);
                        return;
                    }

                    // Parse the VP token
                    const vpResponse = JSON.parse(data.vpToken);

                    // Clear the default message
                    divMessage.innerHTML = '';
                    divMessage.classList.remove('text-danger', 'text-center');

                    // **Create Complete VP Response Card**
                    const completeResponseCard = document.createElement('div');
                    completeResponseCard.className = 'vp-complete-response-card';
                    const completeResponseHeader = document.createElement('h4');
                    completeResponseHeader.className = 'vp-complete-response-header';
                    completeResponseHeader.textContent = 'Complete VP Response (JSON)';
                    const completeResponsePre = document.createElement('pre');
                    completeResponsePre.textContent = JSON.stringify(vpResponse, null, 2);
                    completeResponseCard.appendChild(completeResponseHeader);
                    completeResponseCard.appendChild(completeResponsePre);
                    divMessage.appendChild(completeResponseCard); // Add complete response card first


                    // **Container for Verifiable Credential Cards**
                    const vcCardsContainer = document.createElement('div'); // Just a container, no special class needed for now
                    divMessage.appendChild(vcCardsContainer); // Append container to divMessage

                    // **Iterate through verifiableCredentials array and create individual VC cards**
                    vpResponse.verifiableCredential.forEach(verifiableCredential => {
                        // Create VP Response Card Container (renamed to VC card for clarity)
                        const vcCard = document.createElement('div');
                        vcCard.className = 'vp-response-card'; // Reusing existing card style

                        // VP Response Header (renamed to VC Header)
                        const vcHeader = document.createElement('div');
                        vcHeader.className = 'vp-response-header';
                        const vcIcon = document.createElement('svg'); // You might want to replace this with a proper icon
                        vcIcon.className = 'vp-response-icon';
                        vcIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-1.5 9.75a.75.75 0 0 1 1.5 0v2.25a.75.75 0 0 1-1.5 0V12zm1.5-4.5a.75.75 0 0 1 .75.75h.008a.75.75 0 0 1-.75.75H12a.75.75 0 0 1-.75-.75V7.5a.75.75 0 0 1 .75-.75h.008z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M12 17.25a5.25 5.25 0 1 0 0-10.5 5.25 5.25 0 0 0 0 10.5zm0 1.5a6.75 6.75 0 1 1 0-13.5 6.75 0 0 1 0 13.5z" clip-rule="evenodd" />
                        </svg>`; // Reusing success icon
                        const vcTitle = document.createElement('h3');
                        vcTitle.className = 'vp-response-title';
                        vcTitle.textContent = 'Verifiable Credential Details';
                        vcHeader.appendChild(vcIcon);
                        vcHeader.appendChild(vcTitle);
                        vcCard.appendChild(vcHeader);


                        // VP Response Body (renamed to VC Body)
                        const vcBody = document.createElement('div');
                        vcBody.className = 'vp-response-body';
                        const vcDetail = document.createElement('p');
                        vcDetail.className = 'vp-response-detail';
                        vcDetail.textContent = 'Details of this verifiable credential are shown below:';
                        vcBody.appendChild(vcDetail);
                        vcCard.appendChild(vcBody);


                        // Verifiable Credential Info Section (renamed from subjectInfo)
                        const vcInfo = document.createElement('div');
                        vcInfo.className = 'subject-info'; // Reusing subject-info class for styling

                        // **Iterate through verifiableCredential properties**
                        for (const key in verifiableCredential) {
                            if (verifiableCredential.hasOwnProperty(key) && key !== '@context' && key !== 'type') { // Keep filtering context and type if you prefer

                                const item = document.createElement('div');
                                item.className = 'subject-info-item';
                                const label = document.createElement('span');
                                label.className = 'subject-info-label';
                                label.textContent = key;
                                const value = document.createElement('p');
                                value.className = 'subject-info-value';

                                // Handle objects and arrays as values
                                if (typeof verifiableCredential[key] === 'object') {
                                    value.textContent = JSON.stringify(verifiableCredential[key], null, 2);
                                    value.style.whiteSpace = 'pre-wrap';
                                } else {
                                    value.textContent = verifiableCredential[key];
                                }

                                item.appendChild(label);
                                item.appendChild(value);
                                vcInfo.appendChild(item);
                            }
                        }
                        vcBody.appendChild(vcInfo); // Append VC info to VC body
                        vcCard.appendChild(vcBody); // Append VC body to VC card
                        vcCardsContainer.appendChild(vcCard); // Append individual VC card to the container

                    });


                    window.history.replaceState(null, '', window.location.pathname);
                })
                .catch((error) => {
                    console.error('Error:', error);
                    divMessage.textContent = 'Failed iota request.';
                    divMessage.classList.add('text-danger');
                    window.history.replaceState(null, '', window.location.pathname);
                });


        }

        // Button configuration mapping for new design
        const buttonConfigs = [
            { id: 'personal-btn', queryId: "{{ query_id_personalInformation }}", label: 'Share Personal Information Credentials' },
            { id: 'education-btn', queryId: "{{ query_id_education }}", label: 'Share Education Information Credentials' },
            { id: 'employment-btn', queryId: "{{ query_id_employment }}", label: 'Share Employment Information Credentials' },
            { id: 'address-btn', queryId: "{{ query_id_address }}", label: 'Share Address Information Credentials' },
            { id: 'selective-btn', queryId: "{{ query_id_selective_sharing }}", label: 'Showcase Selective Sharing Credentials' }
        ];

        buttonConfigs.forEach(cfg => {
            const btn = document.getElementById(cfg.id);
            if (btn) {
                btn.addEventListener('click', function() {
                    divMessage.classList.remove('text-danger');
                    divMessage.textContent = `Initiating request for ${cfg.label}`;

                    const nonce = crypto.randomUUID().slice(0, 10);
                    const configurationId = "{{ config_id }}";
                    const redirectUri = window.location.href;

                    fetch('/api/iota-start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            configurationId,
                            queryId: cfg.queryId,
                            redirectUri,
                            nonce,
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Success:', data);
                        if (!data.correlationId || !data.transactionId) {
                            divMessage.textContent = 'Failed to request credential: ' + '' + data.message;
                            divMessage.classList.add('text-danger');
                            return;
                        }
                        divMessage.textContent = "Got the response from initiated request";

                        const toStore = {
                            nonce,
                            queryId: cfg.queryId,
                            configurationId,
                            correlationId: data.correlationId,
                            transactionId: data.transactionId,
                        };

                        localStorage.setItem("iotaRedirect", JSON.stringify(toStore));
                        divMessage.textContent = "Redirecting to vault...";
                        window.location.href = data.vaultLink;
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        divMessage.textContent = 'Failed iota request.';
                        divMessage.classList.add('text-danger');
                    });
                });
            }
        });
    </script>
</body>

</html>